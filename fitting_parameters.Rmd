---
title: "Fitting parameters"
author: "Mackenzie Johnson"
date: "12/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Varying the number of parameters used for fitting amino acid distributions

This is the RMarkdown document used to produce Figure 6. It compares results for fitting distributions with a different number of parameters.

Load necessary packages
```{r, message=FALSE}
library(tidyverse)
library(stringr)
library(cowplot)
library(broom)
library(ggtext)
theme_set(theme_cowplot())

# mean chi square
# does one dist systematically fit better
# aic or lrt to see if increase in parameter is worth it
# distribution of chi square
```


Read in and format data
```{r, message=FALSE}
# read in data
alignment <-read_csv("data/simulated/results_1B4T_A_evolved_split.csv", 
                     col_types = cols(.default = "c")) 

# tidy data used for null
alignment %>% 
  mutate(sequence = as.numeric(1:nrow(alignment)) ) %>% 
  gather(key = "site", value = "aa", 1:153) -> tidy_align  

tidy_align$site = as.numeric(tidy_align$site) 

```


Actual distribution
```{r, message=FALSE}
# determine the number of each AA at each site
tidy_align %>% 
  group_by(site, aa) %>% 
  summarize(count = n()) -> site_aa_count

empty_counts <- tibble(aa = c('A', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'K', 'L', 'M', 
                              'N', 'P', 'Q', 'R', 'S', 'T', 'V', 'W', 'Y'), 
                           count = rep(0, 20))

# 1. First write a function that can take a data frame with amino acids at one site, and return a data frame with counts, including zeros.
count_by_site <- function(site_df) {
  site_df %>% 
    group_by(aa) %>% 
    summarize(count = n()) -> counts
  full_join(counts, anti_join(empty_counts, counts, by = 'aa'))
}

# 2. Then call that function for all sites and combine the resulting data frames.
tidy_align %>% 
  nest(data = -site) %>%
  mutate(counts = map(data, count_by_site)) %>%
  dplyr::select(-data) %>%   
  unnest(cols = c(counts)) -> all_count

```


Estimated distribution
```{r, message=FALSE}
# USING ONLY OBSERVED AA
# order aa by relative frequency
all_count %>%
  arrange(all_count$site, desc(count)) -> ordered_count

# make the categorical variable (aa) numerical (k) by numbering aa's 1-20 in order of freq
ordered_count %>%
  group_by(site) %>%
  mutate(k = as.numeric(1:20)) -> ordered_count

# remove aa with zero values
ordered_count %>%
  filter(count > 0) -> observed_aa

# count relative to most frequent - rescale to 1 for highly conserved sites
observed_aa %>%
  group_by(site) %>%
  mutate(rel_count = count/max(count)) -> observed_aa

# log-transformed data
observed_aa %>%
  mutate(ln_count = log(rel_count)) -> observed_aa 

```


1 parameter fit
```{r, message=FALSE}
# fit linear model to normalized, log-transformed data
# set intercept to 0, only fitting 1 parameter (slope)

observed_aa %>% 
  nest(data = -site) %>%
  mutate(fit = map(data, ~ lm(ln_count ~ 0 + k, data = .)),
         #intercept = map_dbl(fit, ~ (.)$coefficients[1]),
         slope_1 = map_dbl(fit, ~ (.)$coefficients[1])) %>% 
  select(-data, -fit) -> observed_fits_1
```


2 parameters fit
```{r, message=FALSE}
# fit linear model to normalized, log-transformed data
# fitting 2 parameters: slope and intercept

observed_aa %>% 
  nest(data = -site) %>%
  mutate(fit = map(data, ~ lm(ln_count ~ k, data = .)),
         intercept_2 = map_dbl(fit, ~ (.)$coefficients[1]),
         slope_2 = map_dbl(fit, ~ (.)$coefficients[2])) %>% 
  select(-data, -fit) -> observed_fits_2
```


3 parameters fit
```{r, message=FALSE}
# fit quadratic model to normalized, log-transformed data
# fitting 3 parameter: slope, slope^2, intercept
# use non-linear model, fit to all aa (add small value to zero counts)

# add a small constant to include aa with zero values
ordered_count %>%
  mutate(count = count + 0.000001) -> observed_aa_mod
ordered_count %>%
  mutate(count_mod = count + 0.000001) -> ordered_count_mod

# count relative to most frequent - rescale to 1 for highly conserved sites
observed_aa_mod %>%
  group_by(site) %>%
  mutate(rel_count = count/max(count)) -> observed_aa_mod

# log-transformed data
observed_aa_mod %>%
  mutate(ln_count = log(rel_count)) -> observed_aa_mod 

observed_aa_mod %>% 
  nest(data = -site) %>%
  mutate(fit = map(data, ~ lm(ln_count ~ k + I(k^2), data = .)),
         intercept_3 = map_dbl(fit, ~ (.)$coefficients[1]),
         slope_3 = map_dbl(fit, ~ (.)$coefficients[2]),
         sqr_slp_3 = map_dbl(fit, ~ (.)$coefficients[3])) %>% 
  select(-data, -fit) -> observed_fits_3


```


Get estimate counts
```{r, message=FALSE}
# combine dataframes of fits
observed_fits_1 %>%
  full_join(., observed_fits_2, by = "site") %>% 
  full_join(., observed_fits_3, by = "site") -> observed_fits

# add rel and ln counts to full dataframe
ordered_count %>%
  group_by(site) %>%
  mutate(rel_count = count/max(count)) -> ordered_count
ordered_count %>%
  mutate(ln_count = log(rel_count)) -> ordered_count

ordered_count %>% 
  left_join(observed_fits, by = "site") %>%
  mutate(est_dist_1 = slope_1*exp(k*slope_1)) -> ordered_count

ordered_count %>% 
  mutate(est_dist_2 = slope_2*exp(k*slope_2+intercept_2),
         est_dist_3 = slope_3*exp(k*slope_3 + k*k*sqr_slp_3 + 
                                    intercept_3)) -> ordered_count

# rescale to compare w raw count
ordered_count %>%
  group_by(site) %>%
  mutate(est_rel_1 = est_dist_1/sum(est_dist_1),
         est_rel_2 = est_dist_2/sum(est_dist_2),
         est_rel_3 = est_dist_3/sum(est_dist_3)) %>%
  mutate(est_count_1 = sum(count)*est_rel_1,
         est_count_2 = sum(count)*est_rel_2,
         est_count_3 = sum(count)*est_rel_3) -> ordered_count

```



Chi-squared test: actual vs estimated
```{r, message=FALSE}
# use raw count
ordered_count %>% 
  nest(data = -site) %>%
  ungroup() %>%
  mutate(chisq_1 = map(data, ~ sum(((.$count - .$est_count_1)^2)/.$est_count_1)),
         chisq_2 = map(data, ~ sum(((.$count - .$est_count_2)^2)/.$est_count_2)),
         chisq_3 = map(data, ~ sum(((.$count - .$est_count_3)^2)/.$est_count_3)),
         p_value_1 = map_dbl(chisq_1, ~ pchisq(., 18, lower.tail=FALSE)),
         p_value_2 = map_dbl(chisq_2, ~ pchisq(., 18, lower.tail=FALSE)),
         p_value_3 = map_dbl(chisq_3, ~ pchisq(., 18, lower.tail=FALSE))) %>% 
  select(-data) %>%
  mutate(p.adjusted_1 = p.adjust(p_value_1, method= "fdr"),
         p.adjusted_2 = p.adjust(p_value_2, method= "fdr"),
         p.adjusted_3 = p.adjust(p_value_3, method= "fdr")) -> chisq_results

chisq_results %>% 
  select(site, p.adjusted_1, p.adjusted_2, p.adjusted_3) -> chisq_results

pivot_longer(chisq_results, -site, names_to = "parameters_raw", 
             values_to = "p.adjusted") %>% 
  extract(parameters_raw, "parameters", "p.adjusted_(.*)", remove = T) -> chisq_results

chisq_results %>%
  mutate(result = "pass") -> chisq_results

# REMOVE conserved sites with a single aa
chisq_results %>% 
  filter(p.adjusted != "NaN") -> chisq_results

chisq_results$result[chisq_results$p.adjusted < 0.05] <- "fail"

#chisq_results %>% filter(result == "fail") %>% nrow()/nrow(chisq_results)
#chisq_results$chisq <- as.numeric(chisq_results$chisq)

```


Effective number of amino acids
```{r, message=FALSE}
# eff aa for actual distribution
observed_aa %>%
  group_by(site) %>%
  mutate(frequency = (count)/sum(count)) -> site_aa_freq

site_aa_freq %>% 
  mutate(flnf = frequency*log(frequency)) %>%
  group_by(site) %>% 
  summarize(entropy = -sum(flnf),
            eff_aa = exp(entropy),
            n = length(unique(aa))) -> eff_aa_all

# eff aa for estimated distributions
ordered_count %>% 
  group_by(site) %>%
  mutate(freq_1 = (est_count_1)/sum(est_count_1),
         freq_2 = (est_count_2)/sum(est_count_2),
         freq_3 = (est_count_3)/sum(est_count_3)) %>% 
  select(site, aa, k, freq_1, freq_2, freq_3) -> site_aa_freq_2
site_aa_freq_2 %>% 
  mutate(flnf_1 = freq_1*log(freq_1),
         flnf_2 = freq_2*log(freq_2),
         flnf_3 = freq_3*log(freq_3)) %>%
  group_by(site) %>%
  summarize(entr_1 = -sum(flnf_1),
            entr_2 = -sum(flnf_2),
            entr_3 = -sum(flnf_3),
            eff_aa_est_1 = exp(entr_1),
            eff_aa_est_2 = exp(entr_2),
            eff_aa_est_3 = exp(entr_3)) -> eff_aa_all_est

eff_aa_all_est %>% 
  pivot_longer(c(entr_1, entr_2, entr_3), names_to = "parameters",
               values_to = "entropy_est") %>% 
  extract(parameters, "parameters", "entr_(.*)", remove = T) %>%
  select(site, parameters, entropy_est) -> sub1
  
eff_aa_all_est %>% 
  pivot_longer(c(eff_aa_est_1, eff_aa_est_2, eff_aa_est_3),
               names_to = "parameter",
               values_to = "eff_aa_est") %>% 
  extract(parameter, "parameters", "eff_aa_est_(.*)", remove = T) %>%
  select(site, parameters, eff_aa_est) -> sub2

full_join(sub1, sub2, by = c("site", "parameters")) -> eff_aa_est

left_join(eff_aa_all, eff_aa_est, by = "site") -> compare_eff_aa


```

Find $R^2$ values for each parameter
```{r,message=FALSE}

rsq <- function (x, y) { cor(x, y) ^ 2 }

compare_eff_aa %>% 
  filter(parameters == 1 & !is.na(eff_aa_est)) -> compare_p1

rsq(compare_p1$eff_aa, compare_p1$eff_aa_est) # 0.9552371

compare_eff_aa %>% 
  filter(parameters == 2 & !is.na(eff_aa_est)) -> compare_p2

rsq(compare_p2$eff_aa, compare_p2$eff_aa_est) # 0.8203932

compare_eff_aa %>% 
  filter(parameters == 3 & !is.na(eff_aa_est)) -> compare_p3

rsq(compare_p3$eff_aa, compare_p3$eff_aa_est) # 0.7725455

```



Figure 6
```{r, message=FALSE}

dat_text <- data.frame( label = c("*R*<sup>2</sup> = 0.9552371", 
                                  "*R*<sup>2</sup> = 0.8203932", 
                                  "*R*<sup>2</sup> = 0.7725455"),
                        parameters = c(1, 2, 3),
                        x = c(11.25, 11.25, 11.25),
                        y = c(2, 2, 2))

# compare_eff_aa %>% 
#   mutate(label = case_when(parameters == 1 ~ "*R*<sup>2</sup> = 0.9552371",
#                            parameters == 2 ~ "*R*<sup>2</sup> = 0.8203932",
#                            parameters == 3 ~ "*R*<sup>2</sup> = 0.7725455")) -> compare_eff_aa

ggplot(compare_eff_aa, 
       aes(x=eff_aa, y=eff_aa_est)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) + 
  labs(x = "*n*<sub>eff</sub> of actual distribution", 
       y = "*n*<sub>eff</sub> of fit distribution") +
  #geom_richtext(data = dat_text, aes(label = label)) #+
  geom_richtext(data = dat_text, 
                aes(x = x, y = y,label = label),
                label.color = NA,
                inherit.aes = FALSE) +
  facet_grid(vars(parameters)) + 
  theme_cowplot(12, rel_small = 1) +
  panel_border() +
  background_grid() +
  theme(
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    strip.background = element_rect(fill = "gray90")) -> fig6

fig6

save_plot("figure6.png", fig6, ncol = 1, nrow = 1, base_height = 5,
          base_asp = 1.618, base_width = NULL)

```

Other figure
```{r}
chisq_results %>% 
  ggplot(aes(x = p.adjusted, fill = parameters)) +
  geom_histogram() +
  #facet_wrap(vars(parameters)) #+
  scale_y_log10() 

chisq_results %>% 
  ggplot(aes(x = p.adjusted)) +
  geom_histogram() +
  facet_grid(vars(parameters)) +
  scale_y_log10()



```


